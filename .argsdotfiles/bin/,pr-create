#!/usr/bin/env python

import subprocess
import openai
import os
import shlex
from yaspin import yaspin

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

current_branch = subprocess.check_output(
    "git branch --show-current", shell=True, universal_newlines=True).strip()

if current_branch == "main" or current_branch == "master":
    print("Error: cannot create pull request from main or master branch. Checkout to some branch first.")
    exit(1)


def gitprlog():
    print("Collecting git log...")
    try:
        base_commit = subprocess.check_output(
            "git merge-base HEAD $(git show-ref --verify --quiet refs/heads/main && echo 'main' || echo 'master')",
            shell=True,
            universal_newlines=True
        ).strip()

        output = subprocess.check_output(
            f'git log --reverse --pretty=format:"* %s%n%w(0,4,4)%b" {base_commit}..HEAD',
            shell=True,
            universal_newlines=True
        )
        return output
    except subprocess.CalledProcessError as e:
        print(f"An error occurred while collecting git log: {str(e)}")
        return None


def summarize_text(text):
    prompt = f"You are expert software engineer preparing a title of PR. Summarize a key changes into a short (max 100 chars) PR title from git log:\n\n{text}\n\nCommit message:"
    openai.api_key = OPENAI_API_KEY

    with yaspin(text="Summarizing", color="yellow") as spinner:
        try:
            response = openai.ChatCompletion.create(
                model='gpt-3.5-turbo',
                temperature=0.1,
                n=1,
                messages=[
                    {'role': 'user', 'content': prompt}
                ]
            )
            summary = response.choices[0].message.content.strip().strip('"')
            spinner.ok("✔")
            return summary
        except Exception as e:
            spinner.fail("✗")
            print(f"An error occurred during summarization: {str(e)}")
            return None


def create_pull_request(title, body):
    print("Creating pull request...")
    title = shlex.quote(title)
    body = shlex.quote(body)
    command = f'gh pr create --assignee @me --title {title} --body {body}'
    exit_code = os.system(command)
    if exit_code == 0:
        print("Pull request created successfully.")
    else:
        print("An error occurred while creating the pull request.")


body = gitprlog()
if body:
    title = summarize_text(body)
    if title:
        create_pull_request(title, body)
