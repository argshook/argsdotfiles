#!/usr/bin/env python

import subprocess
import openai
import os
import shlex
from yaspin import yaspin

OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")

current_branch = subprocess.check_output(
    "git branch --show-current", shell=True, universal_newlines=True).strip()

if current_branch == "main" or current_branch == "master":
    print("Error: cannot create pull request from main or master branch. Checkout to some branch first.")
    exit(1)


def git_branch():
    with yaspin(text="Collecting git branch", color="yellow") as spinner:
        try:
            output = subprocess.check_output(
                "git branch --show-current", shell=True, universal_newlines=True).strip()
            spinner.ok("✔")
            return output
        except subprocess.CalledProcessError as e:
            spinner.fail("✗")
            print(f"An error occurred while collecting git branch: {str(e)}")
            return None


def gitprlog():
    with yaspin(text="Collecting git log", color="yellow") as spinner:
        try:
            base_commit = subprocess.check_output(
                "git merge-base HEAD $(git show-ref --verify --quiet refs/heads/main && echo 'main' || echo 'master')",
                shell=True,
                universal_newlines=True
            ).strip()

            output = subprocess.check_output(
                f'git log --reverse --pretty=format:"* %s%n%w(0,4,4)%b" {base_commit}..HEAD',
                shell=True,
                universal_newlines=True
            )
            spinner.ok("✔")
            return output
        except subprocess.CalledProcessError as e:
            spinner.fail("✗")
            print(f"An error occurred while collecting git log: {str(e)}")
            return None


def generate_chat_response(prompt, log_text):
    openai.api_key = OPENAI_API_KEY

    with yaspin(text=log_text, color="yellow") as spinner:
        try:
            response = openai.ChatCompletion.create(
                model='gpt-4',
                temperature=0.2,
                function_call={'name': "create_pr"},
                functions=[
                    {
                        'name': "create_pr",
                        'description': "Generate next step of the story, illustration and two choices",
                        'parameters': {
                            'type': "object",
                            'properties': {
                                'title': {
                                    'type': "string",
                                    'description': "Short title (max 100) chars",
                                },
                                'description': {
                                    'type': "string",
                                    'description':
                                    """Short and accurate description. It should be quick and easy to understand for reviewers. Use markdown format if needed (e.g. bullet lists, code snippets and similar).""",
                                },
                            },
                            'required': ['title', 'description'],
                        },
                    },
                ],
                n=1,
                messages=[
                    {
                        'role': 'system',
                        'content': """you are expert software engineer preparing title and description for GitHub Pull
                        Request. You are given branch name and git commit log and using them you summarize the key changes into a short (max 100 chars) title and description.""".strip()
                    },
                    {'role': 'user', 'content': f"Branch name: {current_branch}"},
                    {'role': 'user', 'content': f"Git log:\n\n{git_log}"}
                ]
            )

            api_response: str | None = response['choices'][0]['message']['function_call'][
                'arguments'] if 'function_call' in response['choices'][0]['message'] else None

            if api_response:
                try:
                    parsed = json.loads(api_response)
                    title = parsed['title']
                    description = parsed['description']
                    spinner.ok("✔")
                    return title, description
                except Exception as e:
                    spinner.fail("✗")
                    print(
                        f"An error occurred during chat response parsing: {str(e)}")
                    return None, None

            spinner.fail("✗")
            return None, None
        except Exception as e:
            spinner.fail("✗")
            print(
                f"An error occurred during chat response generation: {str(e)}")
            return None, None




    return generate_chat_response(prompt, "Summarizing body")


def create_pull_request(title, body):
    print("Creating pull request...")
    title = shlex.quote(title)
    body = shlex.quote(body)
    command = f'gh pr create --assignee @me --title {title} --body {body}'
    exit_code = os.system(command)
    if exit_code == 0:
        print("Pull request created successfully.")
    else:
        print("An error occurred while creating the pull request.")


git_log = gitprlog()
if git_log:
    title = generate_title(git_log)
    description = generate_description(git_log)
    log = git_log.replace('\n\n', '\n')
    body = f"{description}\n\nCommit log:\n\n{log}"
    if title and body:
        create_pull_request(title, body)
    else:
        print("An error occurred while generating title or description.")
        print("Pull request will not be created.")
